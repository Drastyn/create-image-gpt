name: "OpenAI GPT"
inputs:
  input-artifact: 
    description: "Prompt para generar imagen"
    required: true
    type: string
  prompt-file: 
    description: "archivo de prompt"
    required: true
    type: string
  GH_TOKEN:
    required: true
    type: string
  OPENAI_API_KEY:
    required: true
    type: string

runs:
  using: "composite"
  steps:

    - name: "Clone Gemini repository"
      shell: bash
      run: git clone https://${{ env.GH_TOKEN }}@github.com/Drastyn/create-image-gpt.git
      env:
        GH_TOKEN: ${{ inputs.GH_TOKEN }}

    - name: "Set up Python"
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: "Set jq"
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install jq

    - name: "Install requirements"
      shell: bash
      run: pip install -r create-image-gpt/requirements.txt

    - name: "Get prompt"
      uses: actions/download-artifact@v4
      with:
        name: ${{ inputs.input-artifact }}
        path: ${{ github.workspace }}/${{ inputs.input-artifact }}

    - name: "Image generation"
      shell: bash
      run: |
        ls ${{ github.workspace }}/${{ inputs.input-artifact }}
        cat ${{ github.workspace }}/${{ inputs.input-artifact }}//${{ inputs.prompt-file }}
        #python3 main.py ${{ github.workspace }}/${{ inputs.input-artifact }}/${{ inputs.prompt-file }}
      env:
        OPENAI_API_KEY: ${{ inputs.OPENAI_API_KEY }}

    - name: "Update attempts"
      shell: bash
      run: |
        current_attempts=$(curl -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ env.GH_TOKEN }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/Drastyn/curso-prompt-coderhouse/actions/variables/ATTEMPTS | jq '.value') 
        new_attempts=$(python3 -c "print(int($current_attempts) + 1)" 2>&1)
        echo "intentos: $new_attempts"
        curl -L -X PATCH -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${GH_TOKEN}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/Drastyn/curso-prompt-coderhouse/actions/variables/ATTEMPTS -d '{"name":"ATTEMPTS","value":"$new_attempts"}'
      env:
        GH_TOKEN: ${{ inputs.GH_TOKEN }}
      
